---
- name: Get GitHub Personal Access Token from AWS Secrets Manager
  set_fact:
    github_access_token: "{{ lookup('aws_secret', 'all/heezy/github/runner/personal-access-token', region='us-east-2') | from_json | json_query('token') }}"

- name: Get terraform-heezy registration token
  uri:
    url: "https://api.github.com/repos/tnielsen2/terraform-heezy/actions/runners/registration-token"
    headers:
      Authorization: "token {{ github_access_token }}"
      Accept: "application/vnd.github.v3+json"
    method: POST
    status_code: 201
  register: terraform_registration
  delegate_to: localhost
  become: false
  run_once: true

- name: Get ansible-heezy registration token
  uri:
    url: "https://api.github.com/repos/tnielsen2/ansible-heezy/actions/runners/registration-token"
    headers:
      Authorization: "token {{ github_access_token }}"
      Accept: "application/vnd.github.v3+json"
    method: POST
    status_code: 201
  register: ansible_registration
  delegate_to: localhost
  become: false
  run_once: true

- name: Update package cache
  apt:
    update_cache: yes

- name: Install required packages
  apt:
    name:
      - curl
      - wget
      - unzip
      - jq
      - git
      - gpg
      - lsb-release
      - ca-certificates
      - gnupg
      - software-properties-common
      - apt-transport-https
    state: present

- name: Check if AWS CLI is installed
  command: which aws
  register: aws_cli_check
  failed_when: false
  changed_when: false

- name: Install AWS CLI
  block:
    - name: Download AWS CLI
      get_url:
        url: "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip"
        dest: "/tmp/awscliv2.zip"
    - name: Extract AWS CLI
      unarchive:
        src: "/tmp/awscliv2.zip"
        dest: "/tmp"
        remote_src: yes
    - name: Install AWS CLI
      command: /tmp/aws/install
      args:
        creates: /usr/local/bin/aws
  when: aws_cli_check.rc != 0

- name: Check if Docker is installed
  command: which docker
  register: docker_check
  failed_when: false
  changed_when: false

- name: Install Docker
  block:
    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present
    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present
    - name: Install Docker
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
        update_cache: yes
  when: docker_check.rc != 0

- name: Check if GitHub CLI is installed
  command: which gh
  register: gh_check
  failed_when: false
  changed_when: false

- name: Install GitHub CLI
  block:
    - name: Add GitHub CLI GPG key
      apt_key:
        url: https://cli.github.com/packages/githubcli-archive-keyring.gpg
        keyring: /usr/share/keyrings/githubcli-archive-keyring.gpg
        state: present
    - name: Add GitHub CLI repository
      apt_repository:
        repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main"
        state: present
    - name: Install GitHub CLI
      apt:
        name: gh
        state: present
        update_cache: yes
  when: gh_check.rc != 0

- name: Check if Terraform is installed
  command: which terraform
  register: terraform_check
  failed_when: false
  changed_when: false

- name: Install Terraform
  block:
    - name: Download HashiCorp GPG key
      get_url:
        url: https://apt.releases.hashicorp.com/gpg
        dest: /tmp/hashicorp.gpg
    - name: Add HashiCorp GPG key
      command: gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg /tmp/hashicorp.gpg
      args:
        creates: /usr/share/keyrings/hashicorp-archive-keyring.gpg
    - name: Add HashiCorp repository
      apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com {{ ansible_distribution_release }} main"
        state: present
    - name: Install Terraform
      apt:
        name: terraform
        state: present
        update_cache: yes
  when: terraform_check.rc != 0

- name: Create actions-runner directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ ansible_env.HOME }}/actions-runner-terraform"
    - "{{ ansible_env.HOME }}/actions-runner-ansible"

- name: Check if GitHub Actions runner is downloaded
  stat:
    path: /tmp/actions-runner.tar.gz
  register: runner_archive

- name: Download GitHub Actions runner
  get_url:
    url: "https://github.com/actions/runner/releases/download/v2.327.1/actions-runner-linux-x64-2.327.1.tar.gz"
    dest: "/tmp/actions-runner.tar.gz"
  when: not runner_archive.stat.exists

- name: Check if terraform runner directory exists
  stat:
    path: "{{ ansible_env.HOME }}/actions-runner-terraform"
  register: terraform_runner_dir

- name: Extract GitHub Actions runner for terraform repo
  unarchive:
    src: "/tmp/actions-runner.tar.gz"
    dest: "{{ ansible_env.HOME }}/actions-runner-terraform"
    remote_src: yes
  when: not terraform_runner_dir.stat.exists or terraform_runner_dir.stat.size == 0

- name: Check if ansible runner directory exists
  stat:
    path: "{{ ansible_env.HOME }}/actions-runner-ansible"
  register: ansible_runner_dir

- name: Extract GitHub Actions runner for ansible repo
  unarchive:
    src: "/tmp/actions-runner.tar.gz"
    dest: "{{ ansible_env.HOME }}/actions-runner-ansible"
    remote_src: yes
  when: not ansible_runner_dir.stat.exists or ansible_runner_dir.stat.size == 0

- name: Configure terraform-heezy runner
  command: >
    ./config.sh --url https://github.com/tnielsen2/terraform-heezy
    --token {{ terraform_registration.json.token }}
    --name heezy-terraform-runner
    --labels self-hosted,linux,x64,terraform
    --unattended
  args:
    chdir: "{{ ansible_env.HOME }}/actions-runner-terraform"
  become: no

- name: Configure ansible-heezy runner
  command: >
    ./config.sh --url https://github.com/tnielsen2/ansible-heezy
    --token {{ ansible_registration.json.token }}
    --name heezy-ansible-runner
    --labels self-hosted,linux,x64,ansible
    --unattended
  args:
    chdir: "{{ ansible_env.HOME }}/actions-runner-ansible"
  become: no

- name: Install terraform runner service
  command: ./svc.sh install
  args:
    chdir: "{{ ansible_env.HOME }}/actions-runner-terraform"

- name: Install ansible runner service
  command: ./svc.sh install
  args:
    chdir: "{{ ansible_env.HOME }}/actions-runner-ansible"

- name: Start terraform runner service
  command: ./svc.sh start
  args:
    chdir: "{{ ansible_env.HOME }}/actions-runner-terraform"

- name: Start ansible runner service
  command: ./svc.sh start
  args:
    chdir: "{{ ansible_env.HOME }}/actions-runner-ansible"
