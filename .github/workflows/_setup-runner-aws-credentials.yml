name: Setup AWS Credentials

on:
  workflow_call:
    inputs:
      runner-type:
        description: 'Runner type (ubuntu-latest or self-hosted)'
        required: true
        type: string
    outputs:
      runner-access-key:
        description: 'Runner AWS access key'
        value: ${{ jobs.setup.outputs.runner-access-key }}
      runner-secret-key:
        description: 'Runner AWS secret key'
        value: ${{ jobs.setup.outputs.runner-secret-key }}
      ecr-token:
        description: 'ECR login token'
        value: ${{ jobs.setup.outputs.ecr-token }}

jobs:
  setup:
    runs-on: ${{ inputs.runner-type }}
    timeout-minutes: 10
    permissions:
      id-token: write
      contents: read
    outputs:
      runner-access-key: ${{ steps.get-creds.outputs.access-key }}
      runner-secret-key: ${{ steps.get-creds.outputs.secret-key }}
      ecr-token: ${{ steps.get-creds.outputs.ecr-token }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::025066240222:role/GitHubActions-MultiRepo
          aws-region: us-east-2

      - name: Login to ECR
        if: inputs.runner-type == 'self-hosted'
        uses: aws-actions/amazon-ecr-login@v2

      - name: Get runner credentials and ECR token
        id: get-creds
        run: |
          # Get static runner credentials from secrets manager
          CREDS=$(aws secretsmanager get-secret-value --secret-id production/heezy/github_runner/aws_credentials --query SecretString --output text)
          echo "access-key=$(echo $CREDS | jq -r '.AWS_ACCESS_KEY_ID')" >> $GITHUB_OUTPUT
          echo "secret-key=$(echo $CREDS | jq -r '.AWS_SECRET_ACCESS_KEY')" >> $GITHUB_OUTPUT
          
          # Get ECR login token using current assumed role
          ECR_TOKEN=$(aws ecr get-login-password --region us-east-2)
          echo "ecr-token=$ECR_TOKEN" >> $GITHUB_OUTPUT