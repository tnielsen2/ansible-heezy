name: Setup AWS Credentials

on:
  workflow_call:
    inputs:
      runner-type:
        description: 'Runner type (ubuntu-latest or self-hosted)'
        required: true
        type: string
    outputs:
      runner-access-key:
        description: 'Runner AWS access key'
        value: ${{ jobs.setup.outputs.runner-access-key }}
      runner-secret-key:
        description: 'Runner AWS secret key'
        value: ${{ jobs.setup.outputs.runner-secret-key }}
      runner-session-token:
        description: 'Runner AWS session token'
        value: ${{ jobs.setup.outputs.runner-session-token }}

jobs:
  setup:
    runs-on: ${{ inputs.runner-type }}
    timeout-minutes: 10
    permissions:
      id-token: write
      contents: read
    outputs:
      runner-access-key: ${{ steps.get-creds.outputs.access-key }}
      runner-secret-key: ${{ steps.get-creds.outputs.secret-key }}
      runner-session-token: ${{ steps.get-creds.outputs.session-token }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.PROD_AWS_ACCOUNT_NUMBER }}:role/GitHubActions-MultiRepo
          aws-region: us-east-2

      - name: Login to ECR
        if: inputs.runner-type == 'self-hosted'
        uses: aws-actions/amazon-ecr-login@v2

      - name: Get temporary AWS credentials
        id: get-creds
        run: |
          echo "access-key=$AWS_ACCESS_KEY_ID" >> $GITHUB_OUTPUT
          echo "secret-key=$AWS_SECRET_ACCESS_KEY" >> $GITHUB_OUTPUT
          echo "session-token=$AWS_SESSION_TOKEN" >> $GITHUB_OUTPUT